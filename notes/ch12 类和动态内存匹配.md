## ç¬¬åäºŒç«  ç±»å’ŒåŠ¨æ€å†…å­˜åŒ¹é…

åœ¨ç±»æ„é€ å‡½æ•°ä¸­ä½¿ç”¨newè¿ç®—ç¬¦åœ¨ç¨‹åºè¿è¡Œæ—¶åˆ†é…æ‰€éœ€çš„å†…å­˜ã€‚ä¸ºæ­¤ï¼Œé€šå¸¸çš„æ–¹æ³•æ˜¯ä½¿ç”¨ string ç±»ï¼Œå®ƒå°†ä¸ºæ‚¨å¤„ç†å†…å­˜ç®¡ç†ç»†èŠ‚ã€‚

### 12.1 åŠ¨æ€å†…å­˜å’Œç±»

C++ä½¿ç”¨ new å’Œ delete è¿ç®—ç¬¦æ¥åŠ¨æ€æ§åˆ¶å†…å­˜ã€‚ä½†æ˜¯åœ¨ç±»ä¸­ä½¿ç”¨è¿™äº›è¿ç®—ç¬¦å°†å¯¼è‡´è®¸å¤šæ–°çš„ç¼–ç¨‹é—®é¢˜ã€‚å› æ­¤ï¼Œææ„å‡½æ•°å°†æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œè€Œä¸å†æ˜¯å¯æœ‰å¯æ— ã€‚

æ‰©å±•ææ„å‡½æ•°ã€ä½¿æ‰€æœ‰çš„æ„é€ å‡½æ•°ä¸ new ææ„å‡½æ•°åè°ƒä¸€è‡´ã€ç¼–å†™é¢å¤–çš„ç±»æ–¹æ³•æ¥å¸®åŠ©æ­£ç¡®å®Œæˆåˆå§‹åŒ–å’Œå¤åˆ¶ã€‚

#### 12.1.1 å¤ä¹ ç¤ºä¾‹å’Œé™æ€ç±»æˆå‘˜

ï¼ˆ1ï¼‰é™æ€ç±»æˆå‘˜ã€æ–°çš„å­˜å‚¨ç±»å‹ã€‘

* ç¤ºä¾‹ï¼š

  * ```c++
    #pragma once
    // ch12_01_strngbad.h -- flawed string class definition
    #include <iostream>
    #ifndef CH12_01_STRNGBAD_H_
    #define CH12_01_STRNGBAD_H_
    
    class StringBad
    {
    private:
    	char* str;
    	int len;
    	static int num_strings;
    public:
    	StringBad(const char* s);
    	StringBad();
    	~StringBad();
    // friend function
    	friend std::ostream& operator<<(std::ostream& os, const StringBad& st);
    };
    #endif
    ```

  * å¯¹è¿™ä¸ªå£°æ˜ï¼Œéœ€è¦æ³¨æ„çš„æœ‰ä¸¤ç‚¹ï¼š

    * é¦–å…ˆï¼Œå®ƒä½¿ç”¨ char æŒ‡é’ˆ(è€Œä¸æ˜¯ char æ•°ç»„)æ¥è¡¨ç¤ºå§“åã€‚è¿™æ„å‘³ç€ç±»å£°æ˜æ²¡æœ‰ä¸ºå­—ç¬¦ä¸²æœ¬èº«åˆ†é…å­˜å‚¨ç©ºé—´ï¼Œè€Œæ˜¯åœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨ new æ¥ä¸ºå­—ç¬¦åˆ†é…ç©ºé—´ã€‚è¿™é¿å…äº†åœ¨ç±»å£°æ˜ä¸­é¢„å…ˆå®šä¹‰å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚
    * å…¶æ¬¡ï¼Œå°† num_strings æˆå‘˜å£°æ˜ä¸ºé™æ€å­˜å‚¨ç±»ã€‚
      * é™æ€ç±»æˆå‘˜æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼šæ— è®ºåˆ›å»ºäº†å¤šå°‘å¯¹è±¡ï¼Œç¨‹åºéƒ½åªåˆ›å»ºä¸€ä¸ªé™æ€ç±»å˜é‡å‰¯æœ¬ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç±»çš„æ‰€æœ‰å¯¹è±¡å…±äº«åŒä¸€ä¸ªé™æ€æˆå‘˜ï¼Œå°±åƒå®¶ä¸­çš„ç”µè¯å¯ä¾›å…¨ä½“å®¶åº­æˆå‘˜å…±äº«ä¸€æ ·ã€‚å‡è®¾åˆ›å»ºäº†10ä¸ªStringBad å¯¹è±¡ï¼Œå°†æœ‰10ä¸ª str æˆå‘˜å’Œ10ä¸ª len æˆå‘˜ä½†åªæœ‰ä¸€ä¸ªå…±äº«çš„num_stringsæˆå‘˜(å‚è§å›¾ 12.1)è¿™å¯¹äºæ‰€æœ‰ç±»å¯¹éƒ½å…·æœ‰ç›¸åŒå€¼çš„ç±»ç§æœ‰æ•°æ®æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚ä¾‹å¦‚numstringsæˆå‘˜å¯ä»¥è®°å½•æ‰€åˆ›å»ºçš„å¯¹è±¡æ•°ç›®ã€‚
      ![image](https://github.com/CoderSuHang/Cpp-Primer-Plus-Notes/assets/104765251/1bc29af5-e530-45a0-b8c2-7b72c629ba0a)

* ç¤ºä¾‹ï¼šç±»æ–¹æ³•æ–‡ä»¶

  * ```c++
    // ch12_02_strngbad.cpp -- StringBad class methods
    #include <cstring>
    #include "ch12_01_strngbad.h"
    using std::cout;
    
    // initializing static class member
    int StringBad::num_strings = 0;
    
    // class methods
    // construct StringBad from C string
    StringBad::StringBad(const char* s)
    {
    	len = std::strlen(s);
    	str = new char[len + 1];
    	std::strcpy(str, s);
    	num_strings++;
    	cout << num_strings << ": \"" << str
    		<< "\" object created\n";
    }
    
    StringBad::StringBad()
    {
    	len = 4;
    	str = new char[4];
    	std::strcpy(str, "C++");
    	num_strings++;
    	cout << num_strings << ": \"" << str
    		<< "\" default object created\n";
    }
    
    StringBad::~StringBad()
    {
    	cout << "\"" << str << "\" object deleted, ";
    	--num_strings;
    	cout << num_strings << " left\n";
    	delete[] str;
    }
    
    std::ostream& operator <<(std::ostream& os, const StringBad& st)
    {
    	os << st.str;
    	return os;
    }
    ```

  * é™æ€æˆå‘˜num_stringsçš„å€¼åˆå§‹åŒ–ä¸ºé›¶ï¼š

    * ```c++
      int StringBad::num_strings = 0;
      ```

    * ğŸ“Œæ³¨æ„ï¼ä¸èƒ½åœ¨ç±»å£°æ˜ä¸­åˆå§‹åŒ–é™æ€æˆå‘˜å˜é‡ï¼š

      * å› ä¸ºå£°æ˜æè¿°äº†å¦‚ä½•åˆ†é…å†…å­˜ï¼Œä½†å¹¶ä¸åˆ†é…å†…å­˜ã€‚
      * å¯¹äºé™æ€ç±»æˆå‘˜ï¼Œå¯ä»¥åœ¨ç±»å£°æ˜ä¹‹å¤–ä½¿ç”¨å•ç‹¬çš„è¯­å¥æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ˜¯å› ä¸ºé™æ€ç±»æˆå‘˜æ˜¯å•ç‹¬å­˜å‚¨çš„ï¼Œè€Œä¸æ˜¯å¯¹è±¡çš„ç»„æˆéƒ¨åˆ†ã€‚è¯·æ³¨æ„ï¼Œåˆå§‹åŒ–è¯­å¥æŒ‡å‡ºäº†ç±»å‹ï¼Œå¹¶ä½¿ç”¨äº†ä½œç”¨åŸŸè¿ç®—ç¬¦ï¼Œä½†æ²¡æœ‰ä½¿ç”¨å…³é”®å­—staticã€‚
      * åˆå§‹åŒ–æ˜¯åœ¨æ–¹æ³•æ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯åœ¨ç±»å£°æ˜æ–‡ä»¶ä¸­è¿›è¡Œçš„ï¼Œè¿™æ˜¯å› ä¸ºç±»å£°æ˜ä½äºå¤´æ–‡ä»¶ä¸­ï¼Œç¨‹åºå¯èƒ½å°†å¤´æ–‡ä»¶åŒ…æ‹¬åœ¨å…¶ä»–å‡ ä¸ªæ–‡ä»¶ä¸­ã€‚å¦‚æœåœ¨å¤´æ–‡ä»¶ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼Œå°†å‡ºç°å¤šä¸ªåˆå§‹åŒ–è¯­å¥å‰¯æœ¬ï¼Œä»è€Œå¼•å‘é”™è¯¯ã€‚
      * <u>æ³¨æ„ï¼šé™æ€æ•°æ®æˆå‘˜åœ¨ç±»å£°æ˜ä¸­å£°æ˜ï¼Œåœ¨åŒ…å«ç±»æ–¹æ³•çš„æ–‡ä»¶ä¸­åˆå§‹åŒ–ã€‚åˆå§‹åŒ–æ—¶ä½¿ç”¨ä½œç”¨åŸŸè¿ç®—ç¬¦æ¥æŒ‡å‡ºé™æ€æˆå‘˜æ‰€å±çš„ç±»ã€‚ä½†å¦‚æœé™æ€æˆå‘˜æ˜¯æ•´å‹æˆ–æšä¸¾å‹ constï¼Œåˆ™å¯ä»¥åœ¨ç±»å£°æ˜ä¸­åˆå§‹åŒ–</u>

  * ä¸èƒ½å°†ã€std::strcpy(str, s);ã€‘æ”¹æˆã€str = s;ã€‘ï¼Œå› ä¸ºè¿™åªä¿å­˜äº†åœ°å€ï¼Œè€Œæ²¡æœ‰åˆ›å»ºå­—ç¬¦ä¸²å‰¯æœ¬ã€‚

  * ææ„å‡½æ•°ï¼šåˆ é™¤å¯¹è±¡å¯ä»¥é‡Šæ”¾å¯¹è±¡æœ¬èº«å ç”¨çš„å†…å­˜ï¼Œä½†å¹¶ä¸èƒ½è‡ªåŠ¨é‡Šæ”¾å±äºå¯¹è±¡æˆå‘˜çš„æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ã€‚å› æ­¤ï¼Œå¿…é¡»ä½¿ç”¨ææ„å‡½æ•°ã€‚åœ¨ææ„å‡½æ•°ä¸­ä½¿ç”¨ delete è¯­å¥å¯ç¡®ä¿å¯¹è±¡è¿‡æœŸæ—¶ï¼Œç”±æ„é€ å‡½æ•°ä½¿ç”¨ new åˆ†é…çš„å†…å­˜è¢«é‡Šæ”¾ã€‚

    * è­¦å‘Šâ—ã€åœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨ new æ¥åˆ†é…å†…å­˜æ—¶ï¼Œå¿…é¡»åœ¨ç›¸åº”çš„ææ„å‡½æ•°ä¸­ä½¿ç”¨ delete æ¥é‡Šæ”¾å†…å­˜ã€‚å¦‚æœä½¿ç”¨new[] (åŒ…æ‹¬ä¸­æ‹¬å·)æ¥åˆ†é…å†…å­˜ï¼Œåˆ™åº”ä½¿ç”¨ delete[] (åŒ…æ‹¬ä¸­æ‹¬å·)æ¥é‡Šæ”¾å†…å­˜ã€‚

* ç¤ºä¾‹ï¼š

  * ```c++
    // ch12_03_vegnews.cpp -- using new and delete with classes
    // compile with strongbad.cpp
    #include <iostream>
    using std::cout;
    #include "ch12_01_strngbad.h"
    
    void callme1(StringBad&);
    void callme2(StringBad);
    
    int main()
    {
    	using std::endl;
    	{
    		cout << "Starting an inner block.\n";
    		StringBad headline1("Celery Stalks at Midnight");
    		StringBad headline2("Lettuce Prey");
    		StringBad sports("Spinach Leaves Bowl for Dollars");
    
    		cout << "headline1: " << headline1 << endl;
    		cout << "headline2: " << headline2 << endl;
    		cout << "sports: " << sports << endl;
    		
    		callme1(headline1);
    		cout << "headline1: " << headline1 << endl;
    		callme2(headline2);
    		cout << "headline2: " << headline2 << endl;
    		
    		cout << "Initialize one object to another:\n";
    		StringBad sailor = sports;
    		cout << "sailor: " << sailor << endl;
    		cout << "Assign one object to another:\n";
    		StringBad knot;
    		cout << "knot: " << knot << endl;
    		cout << "Exiting the block.\n";
    	}
    	cout << "End of main()\n";
    
    	return 0;
    }
    
    void callme1(StringBad& rsb)
    {
    	cout << "String passed by reference:\n";
    	cout << "    \"" << rsb << "\"\n";
    }
    
    void callme2(StringBad& sb)
    {
    	cout << "String passed by value:\n";
    	cout << "    \"" << sb << "\"\n";
    }
    ```

* ç»“æœï¼š

  * ```c++
    Starting an inner block.
    1: "Celery Stalks at Midnight" object created
    2: "Lettuce Prey" object created
    3: "Spinach Leaves Bowl for Dollars" object created
    headline1: Celery Stalks at Midnight
    headline2: Lettuce Prey
    sports: Spinach Leaves Bowl for Dollars
    String passed by reference:
        "Celery Stalks at Midnight"
    headline1: Celery Stalks at Midnight
    String passed by value:
        "Lettuce Prey"
    "Lettuce Prey" object deleted, 2 left
    headline2: è‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘
    Initialize one object to another:
    sailor: Spinach Leaves Bowl for Dollars
    Assign one object to another:
    3: "C++" default object created
    knot: Celery Stalks at Midnight
    Exiting the block.
    "Celery Stalks at Midnight" object deleted, 2 left
    "Spinach Leaves Bowl for Dollars" object deleted, 1 left
    "è‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘ºè‘º" object deleted, 0 left
    ```

  * æŠ¥é”™ï¼š
    * æ­£å¸¸ï¼Œä¹¦ä¸­æ˜¯åœ¨æœ«å°¾å¯¹è±¡è®¡æ•°ä¸ºè´Ÿï¼Œæˆ‘ä½¿ç”¨è¾ƒæ–°çš„ç¼–è¯‘å™¨å’Œæ“ä½œç³»ç»Ÿï¼Œåœ¨æ˜¾ç¤ºæœ‰å…³-1ä¸ªå¯¹è±¡çš„ä¿¡æ¯ä¹‹å‰ç»ˆç«¯ï¼Œå› ä¸ºè¿™æ ·çš„æœºå™¨å°†æŠ¥å‘Šé€šç”¨ä¿æŠ¤é”™è¯¯ï¼ˆGPFï¼‰ã€‚GPFè¡¨æ˜ç¨‹åºè¯•å›¾è®¿é—®ç¦æ­¢å®ƒè®¿é—®çš„å†…å­˜å•å…ƒï¼Œæ˜¯ä¸€ç§ç³Ÿç³•çš„ä¿¡å·ã€‚
   
  * å½“ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ¥åˆå§‹åŒ–å¦ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œç¼–è¯‘å™¨å°†è‡ªåŠ¨ç”Ÿæˆä¸Šè¿°æ„é€ å‡½æ•°ï¼ˆç§°ä¸ºå¤åˆ¶æ„é€ å‡½æ•°ï¼Œå› ä¸ºå®ƒåˆ›å»ºå¯¹è±¡çš„ä¸€ä¸ªå‰¯æœ¬ï¼‰ï¼š
    * ```c++
      StringBad sailor = StringBad(sports);
      ```
    * è‡ªåŠ¨ç”Ÿæˆçš„æ„é€ å‡½æ•°ä¸çŸ¥é“éœ€è¦æ›´æ–°é™æ€å˜é‡ num_stringï¼Œå› æ­¤ä¼šå°†è®¡æ•°æ–¹æ¡ˆæä¹±ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªä¾‹å­è¯´æ˜çš„æ‰€æœ‰é—®é¢˜éƒ½æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„æˆå‘˜å‡½æ•°å¼•èµ·çš„ï¼Œä¸‹é¢ä»‹ç»è¿™ä¸ªä¸»é¢˜ã€‚å½“ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ¥åˆå§‹åŒ–å¦ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œç¼–è¯‘å™¨å°†è‡ªåŠ¨ç”Ÿæˆä¸Šè¿°æ„é€ å‡½æ•°ï¼ˆç§°ä¸ºå¤åˆ¶æ„é€ å‡½æ•°ï¼Œå› ä¸ºå®ƒåˆ›å»ºå¯¹è±¡çš„ä¸€ä¸ªå‰¯æœ¬ï¼‰ï¼š

#### 12.1.2 ç‰¹æ®Šæˆå‘˜å‡½æ•°
